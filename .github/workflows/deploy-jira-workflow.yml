name: Deploy Jira Integration to All Repositories

on:
  workflow_dispatch:

jobs:
  deploy-jira-workflow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install PyGithub
        run: pip install PyGithub
      
      - name: Deploy Jira integration workflow
        env:
          GITHUB_TOKEN: ${{ secrets.SYNC_GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          from github import Github
          import os
          
          GITHUB_TOKEN = os.environ['GITHUB_TOKEN']
          ORG_NAME = "cleanstart-containers"
          
          # Path to the template file in .github repository
          TEMPLATE_FILE_PATH = ".github/workflows/jira-integration-template.yml"
          
          # Path where the workflow will be deployed in target repositories
          WORKFLOW_PATH = ".github/workflows/jira-integration.yml"
          
          # Repositories to exclude
          EXCLUDE_REPOS = ['.github', '.about-cleanstart-containers', 'exported-repos', 'demo-repository']
          
          g = Github(GITHUB_TOKEN)
          org = g.get_organization(ORG_NAME)
          
          print("=" * 70)
          print("Deploying Jira Integration Workflow")
          print("=" * 70)
          print()
          
          # Read the template file from .github repository
          print("Reading template file from .github repository...")
          try:
              source_repo = g.get_repo(f"{ORG_NAME}/.github")
              template_file = source_repo.get_contents(TEMPLATE_FILE_PATH)
              workflow_content = template_file.decoded_content.decode('utf-8')
              print(f"âœ… Template file loaded successfully")
              print(f"   Path: {TEMPLATE_FILE_PATH}")
              print(f"   Size: {len(workflow_content)} bytes")
          except Exception as e:
              print(f"âŒ Failed to read template file: {e}")
              print(f"   Make sure {TEMPLATE_FILE_PATH} exists in the .github repository")
              exit(1)
          
          print()
          
          # Get all repositories
          repos = [r for r in org.get_repos() if r.name not in EXCLUDE_REPOS]
          print(f"Found {len(repos)} repositories to process")
          print()
          
          created_count = 0
          skipped_count = 0
          error_count = 0
          
          for repo in repos:
              print(f"Processing: {repo.name}")
              print("-" * 70)
              
              try:
                  # Check if workflow file already exists
                  try:
                      existing_file = repo.get_contents(WORKFLOW_PATH, ref=repo.default_branch)
                      print(f"  â­ï¸  Workflow already exists - SKIPPING")
                      skipped_count += 1
                  except:
                      # File doesn't exist, create it
                      repo.create_file(
                          path=WORKFLOW_PATH,
                          message="Add Jira integration workflow",
                          content=workflow_content,
                          branch=repo.default_branch
                      )
                      print(f"  âœ… Created jira-integration.yml")
                      created_count += 1
              
              except Exception as e:
                  print(f"  âŒ Error: {e}")
                  error_count += 1
              
              print()
          
          # Summary
          print("=" * 70)
          print("Deployment Summary")
          print("=" * 70)
          print(f"âœ… Created: {created_count}")
          print(f"â­ï¸  Skipped (already exists): {skipped_count}")
          print(f"âŒ Errors: {error_count}")
          print(f"ðŸ“Š Total processed: {len(repos)}")
          print("=" * 70)
          
          if created_count > 0:
              print()
              print("ðŸŽ‰ Jira integration workflow deployed successfully!")
          EOF
