name: Deploy Jira Integration to All Repositories

on:
  workflow_dispatch:

jobs:
  deploy-jira-workflow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install PyGithub
        run: pip install PyGithub
      
      - name: Deploy Jira integration workflow
        env:
          GITHUB_TOKEN: ${{ secrets.SYNC_GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          from github import Github
          import os
          
          GITHUB_TOKEN = os.environ['GITHUB_TOKEN']
          ORG_NAME = "cleanstart-containers"
          
          # The Jira integration workflow content
          JIRA_WORKFLOW_CONTENT = '''name: Create Jira Ticket
            
            permissions:
              issues: write
              contents: read
            
            on:
              issues:
                types: [opened]
            
            jobs:
              create-ticket:
                uses: cleanstart-containers/.github/.github/workflows/reusable-jira-integration.yml@main
                with:
                  project_key: 'GHRT'
                  issue_type: 'Task'
                secrets:
                  JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
                  JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
                  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
            '''
          
          WORKFLOW_PATH = ".github/workflows/jira-integration.yml"
          EXCLUDE_REPOS = ['.github']
          
          g = Github(GITHUB_TOKEN)
          org = g.get_organization(ORG_NAME)
          
          print("=" * 70)
          print("Deploying Jira Integration Workflow")
          print("=" * 70)
          print()
          
          repos = [r for r in org.get_repos() if r.name not in EXCLUDE_REPOS]
          print(f"Found {len(repos)} repositories to process")
          print()
          
          created_count = 0
          skipped_count = 0
          error_count = 0
          
          for repo in repos:
              print(f"Processing: {repo.name}")
              print("-" * 70)
              
              try:
                  # Check if workflow file already exists
                  try:
                      existing_file = repo.get_contents(WORKFLOW_PATH, ref=repo.default_branch)
                      print(f"  â­ï¸  Workflow already exists - SKIPPING")
                      skipped_count += 1
                  except:
                      # File doesn't exist, create it
                      repo.create_file(
                          path=WORKFLOW_PATH,
                          message="Add Jira integration workflow",
                          content=JIRA_WORKFLOW_CONTENT,
                          branch=repo.default_branch
                      )
                      print(f"  âœ… Created jira-integration.yml")
                      created_count += 1
              
              except Exception as e:
                  print(f"  âŒ Error: {e}")
                  error_count += 1
              
              print()
          
          # Summary
          print("=" * 70)
          print("Deployment Summary")
          print("=" * 70)
          print(f"âœ… Created: {created_count}")
          print(f"â­ï¸  Skipped (already exists): {skipped_count}")
          print(f"âŒ Errors: {error_count}")
          print(f"ðŸ“Š Total processed: {len(repos)}")
          print("=" * 70)
          
          if created_count > 0:
              print()
              print("ðŸŽ‰ Jira integration workflow deployed successfully!")
          EOF
